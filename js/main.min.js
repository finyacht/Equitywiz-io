let shareClasses=[],transactions=[],exitAmount=1e7,summaryChart=null,exitDistributionChart=null,shareClassesTableBody,transactionsTableBody;function init(){shareClasses=[...waterfallCalculator.DEFAULT_SHARE_CLASSES],transactions=[...waterfallCalculator.DEFAULT_TRANSACTIONS],setupEventListeners(),renderShareClasses(),renderTransactions(),updateWaterfallAnalysis()}function setupEventListeners(){document.getElementById("addShareClassBtn").addEventListener("click",addNewShareClassRow),document.getElementById("addTransactionBtn").addEventListener("click",addNewTransactionRow),setupNumericInputs()}function formatNumberWithCommas(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function parseNumberWithCommas(e){return parseFloat(e.replace(/,/g,""))||0}function setupNumericInputs(){var e=document.getElementById("exitAmount");e.addEventListener("input",function(e){var t=parseNumberWithCommas(this.value);exitAmount=t,updateWaterfallAnalysis()}),e.addEventListener("focus",function(){this.value=exitAmount.toString()}),e.addEventListener("blur",function(){this.value=formatNumberWithCommas(exitAmount)}),e.value=formatNumberWithCommas(exitAmount)}function renderShareClasses(){shareClassesTableBody.innerHTML="",shareClasses.forEach(e=>{let t=document.createElement("tr"),a=(t.dataset.id=e.id,t.innerHTML=`
            <td><input type="text" class="name" value="${e.name}" onchange="updateShareClassField(${e.id}, 'name', this.value)"></td>
            <td>
                <select class="type" onchange="updateShareClassField(${e.id}, 'type', this.value)">
                    <option value="preferred" ${"preferred"===e.type?"selected":""}>Preferred</option>
                    <option value="common" ${"common"===e.type?"selected":""}>Common</option>
                </select>
            </td>
            <td><input type="number" class="seniority" min="1" value="${e.t}" onchange="updateShareClassField(${e.id}, 'seniority', this.value)"></td>
            <td>
                <input type="number" class="liquidationPref" min="1" step="0.1" value="${e.i}" 
                onchange="updateShareClassField(${e.id}, 'liquidationPref', this.value)" 
                style="display: ${"preferred"===e.type?"block":"none"}">
                <span style="display: ${"preferred"===e.type?"none":"block"}">-</span>
            </td>
            <td>
                <select class="prefType" onchange="updateShareClassField(${e.id}, 'prefType', this.value)" 
                style="display: ${"preferred"===e.type?"block":"none"}">
                    <option value="non-participating" ${"non-participating"===e.o?"selected":""}>Non-Part.</option>
                    <option value="participating" ${"participating"===e.o?"selected":""}>Part.</option>
                </select>
                <span style="display: ${"preferred"===e.type?"none":"block"}">-</span>
            </td>
            <td>
                <input type="number" class="cap" min="0" step="0.1" 
                value="${e.l||""}" placeholder="No cap"
                onchange="updateShareClassField(${e.id}, 'cap', this.value)"
                style="display: ${"preferred"===e.type&&"participating"===e.o?"block":"none"}">
                <span style="display: ${"preferred"===e.type&&"participating"===e.o?"none":"block"}">${"preferred"===e.type&&"participating"===e.o?"":"No Cap"}</span>
            </td>
            <td>
                <button class="delete" onclick="deleteShareClass(${e.id})">Delete</button>
            </td>
        `,t.querySelector(".type")),n=[t.querySelector(".liquidationPref"),t.querySelector(".prefType")],i=[t.querySelector("td:nth-child(4) span"),t.querySelector("td:nth-child(5) span")],s=t.querySelector(".cap"),r=t.querySelector("td:nth-child(6) span");a.addEventListener("change",function(){let a="preferred"===this.value;n.forEach((e,t)=>{e.style.display=a?"block":"none",i[t].style.display=a?"none":"block"});var e="participating"===t.querySelector(".prefType").value;s.style.display=a&&e?"block":"none",r.style.display=a&&e?"none":"block",r.textContent="No Cap"}),t.querySelector(".prefType")?.addEventListener("change",function(){var e;"preferred"===a.value&&(e="participating"===this.value,s.style.display=e?"block":"none",r.style.display=e?"none":"block",r.textContent="No Cap")}),shareClassesTableBody.appendChild(t)})}function renderTransactions(){transactionsTableBody.innerHTML="",transactions.forEach(t=>{var e=document.createElement("tr");e.dataset.id=t.id,e.innerHTML=`
            <td>
                <select class="shareClass" onchange="updateTransactionField(${t.id}, 'shareClass', this.value)">
                    ${shareClasses.map(e=>`<option value="${e.name}" ${t.p===e.name?"selected":""}>${e.name}</option>`).join("")}
                </select>
            </td>
            <td>
                <input type="text" class="shares" value="${formatNumberWithCommas(t.u)}" 
                onfocus="this.value=this.value.replace(/,/g, '')"
                onblur="this.value=formatNumberWithCommas(parseFloat(this.value.replace(/,/g, '')) || 0)"
                onchange="updateTransactionField(${t.id}, 'shares', parseNumberWithCommas(this.value))">
            </td>
            <td>
                <input type="text" class="investment" value="${formatNumberWithCommas(t.m)}" 
                onfocus="this.value=this.value.replace(/,/g, '')"
                onblur="this.value=formatNumberWithCommas(parseFloat(this.value.replace(/,/g, '')) || 0)"
                onchange="updateTransactionField(${t.id}, 'investment', parseNumberWithCommas(this.value))">
            </td>
            <td>
                <button class="delete" onclick="deleteTransaction(${t.id})">Delete</button>
            </td>
        `,transactionsTableBody.appendChild(e)})}function createTooltip(e){return`
        <span class="tooltip">
            <span class="tooltip-icon">?</span>
            <span class="tooltip-text">${e}</span>
        </span>
    `}function addTooltipsToShareClassRow(a){let n={t:"Determines the order in which share classes receive distributions. Lower numbers have higher priority (1 is highest).",i:"Multiplier applied to the original investment that preferred shareholders receive before common shareholders. E.g., 1x means 100% of investment is returned first.",o:"Non-participating: Preferred shareholders choose either liquidation preference OR pro-rata share. Participating: Preferred shareholders receive BOTH liquidation preference AND pro-rata share.",l:"For participating preferred shares, limits the total return as a multiple of the original investment. E.g., 3x cap means maximum return is 3 times the investment."};Object.keys(n).forEach(e=>{var t=a.querySelector(`.${e}-label`);t&&!t.querySelector(".tooltip")&&(t.innerHTML+=createTooltip(n[e]))})}function addNewShareClassRow(){let e=document.createElement("tr"),t=(e.className="editing-row",e.innerHTML=`
        <td><input type="text" class="name" placeholder="Series A"></td>
        <td>
            <select class="type">
                <option value="preferred">Preferred</option>
                <option value="common">Common</option>
            </select>
        </td>
        <td>
            <label class="seniority-label">
                <input type="number" class="seniority" min="1" value="1">
            </label>
        </td>
        <td>
            <label class="liquidationPref-label">
                <input type="number" class="liquidationPref" min="1" step="0.1" value="1">
            </label>
        </td>
        <td>
            <label class="prefType-label">
                <select class="prefType">
                    <option value="non-participating">Non-Participating</option>
                    <option value="participating">Participating</option>
                </select>
            </label>
        </td>
        <td>
            <label class="cap-label">
                <input type="number" class="cap" min="0" step="0.1" placeholder="No cap">
            </label>
        </td>
        <td class="action-buttons">
            <button class="save" onclick="saveShareClass(this)">Save</button>
            <button class="cancel" onclick="cancelShareClass(this)">Cancel</button>
        </td>
    `,addTooltipsToShareClassRow(e),e.querySelector(".type")),a=[e.querySelector(".liquidationPref"),e.querySelector(".prefType")],n=e.querySelector(".cap");t.addEventListener("change",function(){let t="preferred"===this.value;a.forEach(e=>{e.parentElement.style.display=t?"":"none"}),n.parentElement.style.display=t&&"participating"===e.querySelector(".prefType").value?"":"none"}),e.querySelector(".prefType").addEventListener("change",function(){"preferred"===t.value&&(n.parentElement.style.display="participating"===this.value?"":"none")}),shareClassesTableBody.appendChild(e)}function editShareClass(a){var n=shareClasses.find(e=>e.id===a);if(n){var i=document.createElement("div"),n=(i.className="modal",i.innerHTML=`
        <div class="modal-content">
            <h3>Edit Share Class</h3>
            <div class="form-field">
                <label for="name">Name</label>
                <input type="text" id="name" value="${n.name}">
            </div>
            <div class="form-field">
                <label for="type">Type</label>
                <select id="type">
                    <option value="preferred" ${"preferred"===n.type?"selected":""}>Preferred</option>
                    <option value="common" ${"common"===n.type?"selected":""}>Common</option>
                </select>
            </div>
            <div class="form-field">
                <label for="seniority">Seniority</label>
                <input type="number" id="seniority" min="1" value="${n.t}">
            </div>
            <div class="form-field preferred-only ${"preferred"!==n.type?"hidden":""}">
                <label for="liquidationPref">Liquidation Preference</label>
                <input type="number" id="liquidationPref" min="1" step="0.1" value="${n.i}">
            </div>
            <div class="form-field preferred-only ${"preferred"!==n.type?"hidden":""}">
                <label for="prefType">Preference Type</label>
                <select id="prefType">
                    <option value="non-participating" ${"non-participating"===n.o?"selected":""}>Non-Participating</option>
                    <option value="participating" ${"participating"===n.o?"selected":""}>Participating</option>
                </select>
            </div>
            <div class="form-field preferred-only cap-only ${"preferred"!==n.type||"participating"!==n.o?"hidden":""}">
                <label for="cap">Cap (x)</label>
                <input type="number" id="cap" min="0" step="0.1" value="${n.l||""}" placeholder="No cap">
            </div>
            <div class="form-actions">
                <button onclick="updateShareClass(${a})">Save</button>
                <button onclick="closeModal()">Cancel</button>
            </div>
        </div>
    `,document.body.appendChild(i),document.getElementById("type"));let e=document.querySelectorAll(".preferred-only"),t=document.querySelector(".cap-only");n.addEventListener("change",function(){let t="preferred"===this.value;e.forEach(e=>{e.classList.toggle("hidden",!t)})}),document.getElementById("prefType").addEventListener("change",function(){var e="participating"===this.value;t.classList.toggle("hidden",!e)})}}function updateShareClass(t){var e=shareClasses.find(e=>e.id===t);if(e){let a=document.getElementById("name").value.trim();if(""!==a){var n=document.getElementById("type").value,i=parseInt(document.getElementById("seniority").value)||1,s="preferred"===n&&parseFloat(document.getElementById("liquidationPref").value)||1,r="preferred"===n?document.getElementById("prefType").value:"non-participating",o=document.getElementById("cap")?.value,o="preferred"===n&&"participating"===r&&""!==o?parseFloat(o):null;e.name=a,e.type=n,e.t=i,e.i=s,e.o=r,e.l=o;let t=e.name;transactions.forEach(e=>{e.p===t&&(e.p=a)}),closeModal(),renderShareClasses(),renderTransactions(),updateWaterfallAnalysis()}}}function deleteShareClass(t){let a=shareClasses.find(e=>e.id===t);a&&(shareClasses=shareClasses.filter(e=>e.id!==t),transactions=transactions.filter(e=>e.p!==a.name),renderShareClasses(),renderTransactions(),updateWaterfallAnalysis())}function addNewTransactionRow(){var e=document.createElement("tr");e.className="editing-row",e.innerHTML=`
        <td>
            <select class="shareClass">
                <option value="">Select Class</option>
                ${shareClasses.map(e=>`<option value="${e.name}">${e.name}</option>`).join("")}
            </select>
        </td>
        <td>
            <input type="text" class="shares" value="0" 
            onfocus="this.value=this.value.replace(/,/g, '')"
            onblur="this.value=formatNumberWithCommas(parseFloat(this.value.replace(/,/g, '')) || 0)">
        </td>
        <td>
            <label class="investment-label">
                <input type="text" class="investment" value="0"
                onfocus="this.value=this.value.replace(/,/g, '')"
                onblur="this.value=formatNumberWithCommas(parseFloat(this.value.replace(/,/g, '')) || 0)">
                ${createTooltip("The amount of money invested to acquire these shares. Used to calculate liquidation preferences for preferred shares.")}
            </label>
        </td>
        <td class="action-buttons">
            <button class="save" onclick="saveTransaction(this)">Save</button>
            <button class="cancel" onclick="cancelTransaction(this)">Cancel</button>
        </td>
    `,transactionsTableBody.appendChild(e)}function editTransaction(t){let a=transactions.find(e=>e.id===t);var e;a&&((e=document.createElement("div")).className="modal",e.innerHTML=`
        <div class="modal-content">
            <h3>Edit Transaction</h3>
            <div class="form-field">
                <label for="shareClass">Share Class</label>
                <select id="shareClass">
                    ${shareClasses.map(e=>`<option value="${e.name}" ${a.p===e.name?"selected":""}>${e.name}</option>`).join("")}
                </select>
            </div>
            <div class="form-field">
                <label for="shares">Shares</label>
                <input type="number" id="shares" min="0" value="${a.u}">
            </div>
            <div class="form-field">
                <label for="investment">Investment ($)</label>
                <input type="number" id="investment" min="0" value="${a.m}">
            </div>
            <div class="form-actions">
                <button onclick="updateTransaction(${t})">Save</button>
                <button onclick="closeModal()">Cancel</button>
            </div>
        </div>
    `,document.body.appendChild(e))}function updateTransaction(t){var e,a,n,i=transactions.find(e=>e.id===t);i&&""!==(e=document.getElementById("shareClass").value)&&(a=parseFloat(document.getElementById("shares").value)||0,n=parseFloat(document.getElementById("investment").value)||0,i.p=e,i.u=a,i.m=n,closeModal(),renderTransactions(),updateWaterfallAnalysis())}function deleteTransaction(t){transactions=transactions.filter(e=>e.id!==t),renderTransactions(),updateWaterfallAnalysis()}function closeModal(){var e=document.querySelector(".modal");e&&e.remove()}function updateWaterfallAnalysis(){waterfallCalculator.calculateDetailedWaterfall(shareClasses,transactions,exitAmount);var e=waterfallCalculator.calculateSummaryWaterfall(shareClasses,transactions,exitAmount);renderSummaryTable(e),renderCombinedChart(e),renderExitDistributionChart()}function renderSummaryTable(e){let a=document.querySelector("#summaryTable tbody");a.innerHTML="",e.forEach(e=>{var t=document.createElement("tr");t.innerHTML=`
            <td>${e.name}</td>
            <td>$${e.payout.toLocaleString()}</td>
            <td>${e.percentage}%</td>
        `,a.appendChild(t)});e=document.createElement("tr");e.className="font-bold",e.innerHTML=`
        <td>Total</td>
        <td>$${exitAmount.toLocaleString()}</td>
        <td>100%</td>
    `,a.appendChild(e)}function renderCombinedChart(e){var t=document.getElementById("combinedChart");if(t){summaryChart&&summaryChart.destroy();let n=["Liquidation Preference","Participation","Common Distribution","Additional Distribution","Retained"].map(t=>({label:t,data:e.map(e=>e.components[t]||0),backgroundColor:getDistributionTypeColor(t),borderColor:getDistributionTypeColor(t,.8),borderWidth:1})).filter(e=>e.data.some(e=>0<e));summaryChart=new Chart(t,{type:"bar",data:{labels:e.map(e=>e.name),h:n},options:{v:!0,C:!1,g:{x:{$:!0,grid:{display:!1}},y:{$:!0,T:!0,k:{S:function(e){return"$"+e.toLocaleString()}}}},plugins:{N:{A:{title:function(e){let t=e[0].label;if("Retained by Company"===t)return"Retained by Company";e=shareClasses.find(e=>e.name===t);if(!e)return t;let a=t;return"preferred"===e.type&&(a+=` (${e.o})`,"participating"===e.o)&&e.l&&(a+=` - ${e.l}x cap`),a},label:function(e){var t,a=e.raw;return 0===a?null:(t=(a/exitAmount*100).toFixed(1),`${e.dataset.label}: $${a.toLocaleString()} (${t}%)`)},P:function(a){a[0].label;var e=n.reduce((e,t)=>e+(t.data[a[0].dataIndex]||0),0),t=(e/exitAmount*100).toFixed(1);return[`Total Payout: $${e.toLocaleString()} (${t}%)`]}}},W:{position:"bottom",labels:{F:12,padding:15}}}}})}}function renderExitDistributionChart(){var e=document.getElementById("exitDistributionChart");if(e){exitDistributionChart&&exitDistributionChart.destroy();var t=2*exitAmount;let n=waterfallCalculator.calculateExitDistribution(shareClasses,transactions,t,20);t=[...new Set(shareClasses.filter(t=>transactions.some(e=>e.p===t.name)).map(e=>e.name))].map((a,e)=>{var t=n.exitValues.map((e,t)=>{t=n.distributions[t].find(e=>e.name===a);return t?t.payout:0});return{label:a,data:t,fill:!1,borderColor:waterfallCalculator.getShareClassColor(a,e),backgroundColor:waterfallCalculator.getShareClassColor(a,e,.1),q:.4}});exitDistributionChart=new Chart(e,{type:"line",data:{labels:n.exitValues.map(e=>waterfallCalculator.formatCurrency(e)),h:t},options:{v:!0,C:!1,D:{B:!1,mode:"index"},g:{x:{title:{display:!0,text:"Exit Value"}},y:{T:!0,title:{display:!0,text:"Distribution Amount"},k:{S:e=>waterfallCalculator.formatCurrency(e)}}},plugins:{N:{enabled:!0,mode:"index",B:!1,A:{title:function(e){return"Exit Value: "+e[0].label},label:function(e){return e.dataset.label+": "+waterfallCalculator.formatCurrency(e.raw)}}}}}})}}function getDistributionTypeColor(e,t=1){return{R:`rgba(59, 130, 246, ${t})`,M:`rgba(16, 185, 129, ${t})`,L:`rgba(107, 114, 128, ${t})`,I:`rgba(168, 85, 247, ${t})`,O:`rgba(245, 158, 11, ${t})`}[e]||`rgba(107, 114, 128, ${t})`}document.addEventListener("DOMContentLoaded",function(){shareClassesTableBody=document.querySelector("#shareClassesTable tbody"),transactionsTableBody=document.querySelector("#transactionsTable tbody"),init()}),window.V=function(e){var t,a,n,i,e=e.closest("tr"),s=e.querySelector(".name").value.trim();""!==s&&(t=e.querySelector(".type").value,a=parseInt(e.querySelector(".seniority").value)||1,n="preferred"===t&&parseFloat(e.querySelector(".liquidationPref").value)||1,i="preferred"===t?e.querySelector(".prefType").value:"non-participating",e=e.querySelector(".cap").value,e="preferred"===t&&"participating"===i&&""!==e?parseFloat(e):null,s={id:0<shareClasses.length?Math.max(...shareClasses.map(e=>e.id))+1:1,name:s,type:t,t:a,i:n,o:i,l:e},shareClasses.push(s),renderShareClasses(),renderTransactions(),updateWaterfallAnalysis())},window.Z=function(e){e.closest("tr").remove()},window.j=function(e){var t,e=e.closest("tr"),a=e.querySelector(".shareClass").value;""!==a&&(t=parseNumberWithCommas(e.querySelector(".shares").value),e=parseNumberWithCommas(e.querySelector(".investment").value),a={id:0<transactions.length?Math.max(...transactions.map(e=>e.id))+1:1,p:a,u:t,m:e},transactions.push(a),renderTransactions(),updateWaterfallAnalysis())},window.H=function(e){e.closest("tr").remove()},window.U=addNewShareClassRow,window.G=editShareClass,window.J=updateShareClass,window.K=deleteShareClass,window.X=addNewTransactionRow,window.Y=editTransaction,window._=updateTransaction,window.ee=deleteTransaction,window.te=closeModal,window.ae=function(t,e,n){var i=shareClasses.find(e=>e.id===t);if(i){switch(e){case"name":let t=i.name,a=n.trim();if(""===a)return;i.name=a,transactions.forEach(e=>{e.p===t&&(e.p=a)});break;case"type":"common"===(i.type=n)&&(i.i=1,i.o="non-participating",i.l=null);break;case"seniority":i.t=parseInt(n)||1;break;case"liquidationPref":"preferred"===i.type&&(i.i=parseFloat(n)||1);break;case"prefType":"preferred"===i.type&&"non-participating"===(i.o=n)&&(i.l=null);break;case"cap":"preferred"===i.type&&"participating"===i.o&&(i.l=""!==n?parseFloat(n):null)}renderTransactions(),updateWaterfallAnalysis()}},window.ne=function(t,e,a){var n=transactions.find(e=>e.id===t);if(n){switch(e){case"shareClass":n.p=a;break;case"shares":n.u="string"==typeof a?parseNumberWithCommas(a):a;break;case"investment":n.m="string"==typeof a?parseNumberWithCommas(a):a}updateWaterfallAnalysis()}};