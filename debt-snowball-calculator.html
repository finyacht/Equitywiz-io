<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-RT0B6NXFG6"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-RT0B6NXFG6');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
    <!-- CSP handled by netlify.toml for better control -->
    <title>Debt Snowball Calculator | Equity-Wiz.io</title>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>

    <!-- Shared Styles (from sip/vanilla calculators) -->
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/mobile-responsive.css">

    <style>
        /* Specific Styles for Debt Snowball */
        :root {
            --primary-color: #8B5CF6;
            /* Purple/Budget theme color */
            --primary-dark: #7C3AED;
            --primary-light: #C4B5FD;
            --background-start: #f5f3ff;
            --background-end: #ede9fe;
            --card-bg: rgba(255, 255, 255, 0.95);
            /* Standard Colors */
            --text-main: #1e293b;
            --text-muted: #64748b;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        body {
            background: linear-gradient(135deg, var(--background-start) 0%, var(--background-end) 100%);
            min-height: 100vh;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, Roboto, sans-serif;
            color: var(--text-main);
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Navigation Bar */
        .nav-bar {
            display: flex;
            align-items: center;
            margin-bottom: 24px;
            background: var(--card-bg);
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .nav-bar a {
            text-decoration: none;
            color: var(--text-muted);
            font-weight: 600;
            display: flex;
            align-items: center;
            transition: color 0.2s ease;
            font-size: 0.95rem;
        }

        .nav-bar a:hover {
            color: var(--primary-color);
        }

        .nav-bar svg {
            margin-right: 8px;
            width: 18px;
            height: 18px;
        }

        .nav-separator {
            margin: 0 12px;
            color: #cbd5e1;
        }

        .nav-title {
            color: var(--text-main);
            font-weight: 700;
            font-size: 0.95rem;
        }

        /* Card Layout */
        .card {
            background: var(--card-bg);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 24px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            position: relative;
        }

        .header-card {
            border-left: 5px solid var(--primary-color);
        }

        .mini-logo {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-light));
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(139, 92, 246, 0.3);
            position: relative;
            flex-shrink: 0;
        }

        .mini-logo::before {
            content: "";
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: white;
            clip-path: polygon(50% 0%, 100% 100%, 0% 100%);
            opacity: 0.9;
            top: 10px;
            left: 10px;
        }

        h2 {
            margin: 0 0 15px 0;
            color: var(--text-main);
            font-size: 1.5rem;
            font-weight: 700;
        }

        .author-info {
            display: flex;
            align-items: center;
            color: var(--text-muted);
            font-size: 0.85rem;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e2e8f0;
        }

        .author-info a {
            display: inline-flex;
            margin-left: 6px;
            color: #0a66c2;
        }

        /* Form & Inputs */
        .input-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-main);
            font-size: 0.95rem;
        }

        input[type="number"],
        input[type="text"],
        select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            color: var(--text-main);
            background-color: #f8fafc;
            transition: all 0.2s ease;
            box-sizing: border-box;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color);
            background-color: white;
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .input-with-symbol {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-with-symbol .currency-symbol {
            position: absolute;
            left: 16px;
            color: var(--text-muted);
            font-weight: 600;
            pointer-events: none;
        }

        .input-with-symbol .percent-symbol {
            position: absolute;
            right: 16px;
            color: var(--text-muted);
            font-weight: 600;
            pointer-events: none;
        }

        .input-with-symbol input.has-currency {
            padding-left: 32px;
        }

        /* Debt List Styles */
        .debt-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .debt-item {
            display: grid;
            grid-template-columns: 2fr 1.5fr 1fr 1.5fr auto;
            gap: 12px;
            align-items: start;
            background: #f8fafc;
            padding: 15px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            transition: box-shadow 0.2s, transform 0.2s;
        }

        .debt-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            border-color: #cbd5e1;
        }

        .debt-item .input-group {
            margin-bottom: 0;
        }

        .debt-item label {
            font-size: 0.85rem;
            margin-bottom: 6px;
        }

        .remove-btn {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 8px;
            margin-top: 24px;
            /* Align with inputs */
            border-radius: 50%;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-btn:hover {
            background-color: #fee2e2;
            color: var(--danger);
        }

        .remove-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Buttons */
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);
        }

        .btn-secondary {
            background-color: white;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-secondary:hover {
            background-color: #f5f3ff;
        }

        /* Layout Grid */
        .main-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 24px;
        }

        /* Results Section */
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .result-box {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .result-box.highlight {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            border: none;
            box-shadow: 0 8px 16px rgba(139, 92, 246, 0.2);
        }

        .result-box.highlight .result-label,
        .result-box.highlight .result-subtext {
            color: rgba(255, 255, 255, 0.9);
        }

        .result-label {
            font-size: 0.9rem;
            color: var(--text-muted);
            font-weight: 600;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .result-value {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--text-main);
            margin: 0;
            line-height: 1.2;
        }

        .result-box.highlight .result-value {
            color: white;
        }

        .result-subtext {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: 8px;
        }

        /* Comparison Section */
        .comparison-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 30px;
            border-top: 2px dashed #e2e8f0;
            padding-top: 30px;
        }

        .comparison-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
        }

        .comparison-card.snowball-win {
            border-color: var(--primary-color);
            background: #f5f3ff;
        }

        .comparison-card.snowball-win::before {
            content: "Recommended";
            position: absolute;
            top: 12px;
            right: -30px;
            background: var(--primary-color);
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 4px 30px;
            transform: rotate(45deg);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .comp-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--text-main);
        }

        .comp-date {
            font-size: 2.2rem;
            font-weight: 800;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .comp-interest {
            font-size: 1rem;
            color: var(--danger);
            font-weight: 600;
        }

        .savings-badge {
            display: inline-block;
            background: #dcfce7;
            color: #166534;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.95rem;
            margin-top: 15px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        /* Chart constraints */
        .chart-container {
            position: relative;
            height: 400px;
            width: 100%;
            margin-top: 20px;
        }

        /* Disclaimer */
        .disclaimer {
            font-size: 0.85rem;
            color: var(--text-muted);
            line-height: 1.5;
            background: transparent;
            border: 1px solid rgba(0, 0, 0, 0.1);
            box-shadow: none;
            padding: 20px;
        }

        .snowball-controls {
            background: #f8fafc;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #e2e8f0;
            margin-bottom: 25px;
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .snowball-controls .input-group {
            margin-bottom: 0;
            flex-grow: 1;
        }

        .snowball-controls .info-text {
            flex-grow: 2;
            font-size: 0.95rem;
            color: var(--text-muted);
            line-height: 1.5;
        }

        /* Responsive Design */
        @media (max-width: 900px) {
            .debt-item {
                grid-template-columns: 1fr 1fr;
                position: relative;
                padding-bottom: 50px;
            }

            .debt-item .input-group:first-child {
                grid-column: span 2;
            }

            .remove-btn {
                position: absolute;
                bottom: 10px;
                right: 10px;
                margin-top: 0;
            }
        }

        @media (max-width: 768px) {
            .comparison-section {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 300px;
            }

            .snowball-controls {
                flex-direction: column;
                align-items: stretch;
            }
        }

        @media (max-width: 480px) {
            .debt-item {
                grid-template-columns: 1fr;
            }

            .debt-item .input-group:first-child {
                grid-column: 1;
            }

            .results-grid {
                grid-template-columns: 1fr;
            }

            .card {
                padding: 20px;
            }

            .comp-date {
                font-size: 1.8rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Navigation -->
        <div class="nav-bar">
            <a href="home.html">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
                Home
            </a>
            <span class="nav-separator">/</span>
            <span class="nav-title">Debt Snowball Calculator</span>
        </div>

        <!-- Header -->
        <div class="card header-card">
            <div style="display:flex; align-items:center; gap:15px; margin-bottom: 10px;">
                <div class="mini-logo"></div>
                <h2 style="margin:0;">Debt Snowball Calculator</h2>
            </div>
            <p style="color: var(--text-muted); line-height: 1.6; margin: 0 0 15px 0;">
                Accelerate your journey to becoming debt-free. Discover how paying off your smallest debts first and
                rolling those payments into the next largest debt can save you time and money.
            </p>
            <div class="author-info">
                <span>By <strong>Amal Ganatra</strong></span>
                <a href="https://www.linkedin.com/in/amalganatra/" target="_blank" rel="noopener noreferrer">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor"
                        viewBox="0 0 16 16">
                        <path
                            d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z" />
                    </svg>
                </a>
            </div>
        </div>

        <div class="main-grid">

            <!-- Inputs Section -->
            <div class="card" id="inputsCard">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>1. Enter Your Debts</h2>
                    <button class="btn-secondary" id="addDebtBtn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                        </svg>
                        Add Debt
                    </button>
                </div>

                <div class="debt-list" id="debtList">
                    <!-- Debt items will be generated here by JS -->
                </div>

                <h2 style="margin-top: 30px;">2. Add Extra Payment (The Snowball)</h2>
                <div class="snowball-controls">
                    <div class="info-text">
                        <strong>How much extra can you pay each month?</strong><br>
                        This is the key to the snowball method. Any extra money you put toward your smallest debt will
                        drastically speed up your debt-free date.
                    </div>
                    <div class="input-group">
                        <label for="extraPayment">Extra Monthly Payment</label>
                        <div class="input-with-symbol">
                            <span class="currency-symbol">$</span>
                            <input type="number" id="extraPayment" class="has-currency" value="250" min="0" step="10">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Section -->
            <div class="card" id="resultsCard">
                <h2>Your Debt Breakdown</h2>

                <div class="results-grid">
                    <div class="result-box">
                        <div class="result-label">Total Debt</div>
                        <div class="result-value" id="valTotalDebt">$0</div>
                        <div class="result-subtext" id="valDebtCount">0 accounts</div>
                    </div>

                    <div class="result-box">
                        <div class="result-label">Base Minimum Payments</div>
                        <div class="result-value" id="valTotalMin">$0</div>
                        <div class="result-subtext">Required every month</div>
                    </div>

                    <div class="result-box highlight">
                        <div class="result-label">Total Monthly Payment</div>
                        <div class="result-value" id="valTotalMonthly">$0</div>
                        <div class="result-subtext">Minimums + Snowball</div>
                    </div>
                </div>

                <div class="comparison-section">
                    <div class="comparison-card">
                        <div class="comp-title">Minimum Payments Only</div>
                        <div class="comp-date" id="dateBaseline">---</div>
                        <div class="result-subtext">Debt-free date</div>
                        <div style="margin-top: 20px;">
                            <div class="result-label">Total Interest Paid</div>
                            <div class="comp-interest" id="interestBaseline">$0</div>
                        </div>
                    </div>

                    <div class="comparison-card snowball-win">
                        <div class="comp-title">Debt Snowball Method</div>
                        <div class="comp-date" id="dateSnowball">---</div>
                        <div class="result-subtext">Accelerated debt-free date</div>
                        <div style="margin-top: 20px;">
                            <div class="result-label">Total Interest Paid</div>
                            <div class="comp-interest" style="color:var(--success);" id="interestSnowball">$0</div>
                        </div>
                        <div class="savings-badge" id="savingsBadge" style="display: none;">
                            Save $0 in interest!
                        </div>
                        <div class="time-savings" id="timeSavings"
                            style="color: var(--primary-dark); font-weight: 600; font-size: 0.9rem; margin-top: 10px; display: none;">
                            Debt-free X months sooner
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <canvas id="payoffChart"></canvas>
                </div>
            </div>

            <!-- AI Integration Card -->
            <div class="card ai-card" style="margin-top: 20px;">
                <div style="display:flex; align-items:center; gap:12px; margin-bottom:15px;">
                    <div style="font-size: 24px;">üéØ</div>
                    <h2 style="margin:0;">AI Debt Strategy Planner</h2>
                </div>
                <p style="color: var(--text-muted); font-size: 0.95rem; margin-bottom: 20px;">
                    Ask our AI assistant for personalized advice on optimizing your extra payments or exploring
                    alternative strategies like the Debt Avalanche method based on your current inputs.
                </p>

                <div class="ai-controls"
                    style="display: flex; gap: 10px; margin-bottom: 20px; align-items: stretch; flex-wrap: wrap;">
                    <input id="aiQuery" type="text"
                        placeholder="e.g., Should I use the Avalanche method instead? How can I free up more cash?"
                        style="flex-grow: 1; min-width: 250px;">
                    <button id="aiAskBtn" class="btn-primary" style="white-space: nowrap;">
                        Ask AI
                    </button>
                </div>

                <div id="aiSpinner"
                    style="display: none; color: var(--text-muted); font-style: italic; margin-bottom: 15px;">
                    ü§î AI is analyzing your debt profile...
                </div>

                <div id="aiOutput"
                    style="background: #f8fafc; border-radius: 8px; padding: 15px; border-left: 4px solid var(--primary-color); display: none; line-height: 1.6; font-size: 0.95rem;">
                </div>
            </div>

            <!-- Disclaimer -->
            <div class="card disclaimer">
                <strong>Disclaimer:</strong> This calculator is for educational and informational purposes only and does
                not constitute financial advice. The calculations are based on the information provided and assume that
                interest is calculated monthly and minimum payments remain constant (unless the balance is lower than
                the minimum payment). Actual results may vary based on your specific loan terms, compound interest
                methods used by your lenders, and any changes to interest rates over time.
            </div>

        </div>
    </div>


    <script>
        // --- State ---
        let debts = [
            { id: generateId(), name: 'Credit Card 1', balance: 2500, rate: 19.99, minPayment: 75 },
            { id: generateId(), name: 'Car Loan', balance: 12000, rate: 5.5, minPayment: 250 },
            { id: generateId(), name: 'Student Loan', balance: 25000, rate: 4.5, minPayment: 300 }
        ];

        let chartInstance = null;

        // --- DOM Elements ---
        const debtListEl = document.getElementById('debtList');
        const addDebtBtn = document.getElementById('addDebtBtn');
        const extraPaymentInput = document.getElementById('extraPayment');

        // Output Elements
        const valTotalDebt = document.getElementById('valTotalDebt');
        const valDebtCount = document.getElementById('valDebtCount');
        const valTotalMin = document.getElementById('valTotalMin');
        const valTotalMonthly = document.getElementById('valTotalMonthly');

        const dateBaseline = document.getElementById('dateBaseline');
        const interestBaseline = document.getElementById('interestBaseline');

        const dateSnowball = document.getElementById('dateSnowball');
        const interestSnowball = document.getElementById('interestSnowball');
        const savingsBadge = document.getElementById('savingsBadge');
        const timeSavings = document.getElementById('timeSavings');

        // --- Formatters ---
        const fmtCurrency = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });
        const fmtCurrencyWithCents = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });

        // --- Utilities ---
        function generateId() {
            return Math.random().toString(36).substr(2, 9);
        }

        // --- UI Rendering ---
        function renderDebtList() {
            debtListEl.innerHTML = '';

            debts.forEach((debt, index) => {
                const itemEl = document.createElement('div');
                itemEl.className = 'debt-item';
                itemEl.innerHTML = `
                    <div class="input-group">
                        <label for="name_${debt.id}">Debt Name/Type</label>
                        <input type="text" id="name_${debt.id}" data-id="${debt.id}" data-field="name" value="${debt.name}" placeholder="e.g. Visa Card">
                    </div>
                    <div class="input-group">
                        <label for="balance_${debt.id}">Balance</label>
                        <div class="input-with-symbol">
                            <span class="currency-symbol">$</span>
                            <input type="number" id="balance_${debt.id}" data-id="${debt.id}" data-field="balance" class="has-currency" value="${debt.balance}" min="1" step="0.01">
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="rate_${debt.id}">Interest Rate</label>
                        <div class="input-with-symbol">
                            <input type="number" id="rate_${debt.id}" data-id="${debt.id}" data-field="rate" value="${debt.rate}" min="0" step="0.01">
                            <span class="percent-symbol">%</span>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="min_${debt.id}">Min. Payment</label>
                        <div class="input-with-symbol">
                            <span class="currency-symbol">$</span>
                            <input type="number" id="min_${debt.id}" data-id="${debt.id}" data-field="minPayment" class="has-currency" value="${debt.minPayment}" min="1" step="0.01">
                        </div>
                    </div>
                    <button class="remove-btn" data-id="${debt.id}" title="Remove debt" ${debts.length === 1 ? 'disabled style="opacity:0.3; cursor:not-allowed;"' : ''}>
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                `;
                debtListEl.appendChild(itemEl);
            });

            // Attach event listeners to new elements
            document.querySelectorAll('.debt-item input').forEach(input => {
                input.addEventListener('change', handleInputChange);
                input.addEventListener('input', debounce(calculate, 500));
            });

            document.querySelectorAll('.remove-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.getAttribute('data-id');
                    removeDebt(id);
                });
            });
        }

        function debounce(func, wait) {
            let timeout;
            return function () {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, arguments), wait);
            };
        }

        // --- Event Handlers ---
        function handleInputChange(e) {
            const id = e.target.getAttribute('data-id');
            const field = e.target.getAttribute('data-field');
            let value = e.target.value;

            const debtIndex = debts.findIndex(d => d.id === id);
            if (debtIndex !== -1) {
                if (field === 'name') {
                    debts[debtIndex][field] = value;
                } else {
                    value = parseFloat(value) || 0;
                    if (field === 'balance') debts[debtIndex][field] = value;
                    else if (field === 'rate') debts[debtIndex][field] = value;
                    else if (field === 'minPayment') debts[debtIndex][field] = value;
                }
            }
            calculate();
        }

        function addDebt() {
            debts.push({
                id: generateId(),
                name: `Debt ${debts.length + 1}`,
                balance: 1000,
                rate: 15.0,
                minPayment: 50
            });
            renderDebtList();
            calculate();
        }

        function removeDebt(id) {
            if (debts.length > 1) {
                debts = debts.filter(d => d.id !== id);
                renderDebtList();
                calculate();
            }
        }

        addDebtBtn.addEventListener('click', addDebt);
        extraPaymentInput.addEventListener('input', debounce(calculate, 500));

        // --- Core Logic ---
        function calculateAmortization(debtArray, extraSnowballPayment) {
            // Clone and format debts
            let currentDebts = debtArray.map(d => ({
                id: d.id,
                name: d.name,
                balance: parseFloat(d.balance) || 0,
                rate: (parseFloat(d.rate) || 0) / 100 / 12, // Monthly interest rate
                min: parseFloat(d.minPayment) || 0,
                paidOff: false
            })).filter(d => d.balance > 0);

            // Sort by snowball method (lowest balance first)
            currentDebts.sort((a, b) => a.balance - b.balance);

            let totalInterest = 0;
            let month = 0;
            let schedule = [{
                month: 0,
                totalBalance: currentDebts.reduce((sum, d) => sum + d.balance, 0)
            }];

            const MAX_MONTHS = 600; // 50 years max to prevent infinite loops

            while (currentDebts.some(d => !d.paidOff) && month < MAX_MONTHS) {
                month++;
                let availableSnowball = extraSnowballPayment;

                // First pass: Calculate interest and process minimum payments
                for (let i = 0; i < currentDebts.length; i++) {
                    let d = currentDebts[i];
                    if (d.paidOff) {
                        // Rollover the minimum payment of paid off debts to the snowball
                        availableSnowball += d.min;
                        continue;
                    }

                    let interest = d.balance * d.rate;
                    totalInterest += interest;
                    d.balance += interest;

                    // Pay minimum
                    if (d.balance <= d.min) {
                        // Debt is paid off with mostly min payment
                        availableSnowball += (d.min - d.balance); // Add remaining min payment to snowball
                        d.balance = 0;
                        d.paidOff = true;
                    } else {
                        d.balance -= d.min;

                        // Check if min payment is enough to cover interest
                        if (d.min <= interest && extraSnowballPayment === 0) {
                            // INFINITE LOOP warning - debt will never be paid off with min payment
                            return { error: true, message: `Minimum payment on ${d.name} is not covering interest.` };
                        }
                    }
                }

                // Second pass: Apply accumulated snowball to the highest priority debt (lowest balance)
                if (availableSnowball > 0) {
                    for (let i = 0; i < currentDebts.length; i++) {
                        let d = currentDebts[i];
                        if (!d.paidOff) {
                            if (d.balance <= availableSnowball) {
                                availableSnowball -= d.balance;
                                d.balance = 0;
                                d.paidOff = true;
                            } else {
                                d.balance -= availableSnowball;
                                availableSnowball = 0;
                                break; // Snowball used up
                            }
                        }
                    }
                }

                let endBalance = currentDebts.reduce((sum, d) => sum + d.balance, 0);
                schedule.push({
                    month: month,
                    totalBalance: endBalance
                });
            }

            return {
                months: month,
                totalInterest: totalInterest,
                schedule: schedule,
                error: month >= MAX_MONTHS
            };
        }

        function addMonthsToDate(months) {
            const date = new Date();
            date.setMonth(date.getMonth() + months);
            return date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
        }

        function calculate() {
            // Get inputs
            const extraMonthly = parseFloat(extraPaymentInput.value) || 0;

            // Basic sums
            const totalDebt = debts.reduce((sum, d) => sum + (parseFloat(d.balance) || 0), 0);
            const totalMin = debts.reduce((sum, d) => sum + (parseFloat(d.minPayment) || 0), 0);

            // Update summary UI
            valTotalDebt.textContent = fmtCurrency.format(totalDebt);
            valDebtCount.textContent = `${debts.length} account${debts.length !== 1 ? 's' : ''}`;
            valTotalMin.textContent = fmtCurrency.format(totalMin);
            valTotalMonthly.textContent = fmtCurrency.format(totalMin + extraMonthly);

            // Calculate Baseline (Minimums only, extra = 0)
            const baselineRes = calculateAmortization(debts, 0);

            // Calculate Snowball (Minimums + Extra)
            const snowballRes = calculateAmortization(debts, extraMonthly);

            // Update Baseline UI
            if (baselineRes.error) {
                dateBaseline.textContent = "Never";
                dateBaseline.style.color = "var(--danger)";
                dateBaseline.style.fontSize = "1.5rem";
                interestBaseline.textContent = "Infinite (Min pays < Interest)";
            } else {
                dateBaseline.textContent = addMonthsToDate(baselineRes.months);
                dateBaseline.style.color = "var(--primary-color)";
                dateBaseline.style.fontSize = "2.2rem";
                interestBaseline.textContent = fmtCurrency.format(baselineRes.totalInterest);
            }

            // Update Snowball UI
            if (snowballRes.error) {
                dateSnowball.textContent = "Never";
                interestSnowball.textContent = "Adjust Payments";
                savingsBadge.style.display = 'none';
                timeSavings.style.display = 'none';
            } else {
                dateSnowball.textContent = addMonthsToDate(snowballRes.months);
                interestSnowball.textContent = fmtCurrency.format(snowballRes.totalInterest);

                // Show savings if baseline is valid
                if (!baselineRes.error && extraMonthly > 0) {
                    const interestSaved = baselineRes.totalInterest - snowballRes.totalInterest;
                    const monthsSaved = baselineRes.months - snowballRes.months;

                    if (interestSaved > 0) {
                        savingsBadge.textContent = `Save ${fmtCurrency.format(interestSaved)} in interest!`;
                        savingsBadge.style.display = 'inline-block';
                    } else {
                        savingsBadge.style.display = 'none';
                    }

                    if (monthsSaved > 0) {
                        const years = Math.floor(monthsSaved / 12);
                        const monthRemainder = monthsSaved % 12;
                        let timeStr = "";
                        if (years > 0) timeStr += `${years} year${years > 1 ? 's' : ''} `;
                        if (monthRemainder > 0) timeStr += `${monthRemainder} month${monthRemainder > 1 ? 's' : ''}`;

                        timeSavings.textContent = `Debt-free ${timeStr} sooner`;
                        timeSavings.style.display = 'block';
                    } else {
                        timeSavings.style.display = 'none';
                    }
                } else {
                    savingsBadge.style.display = 'none';
                    timeSavings.style.display = 'none';
                }
            }

            // Render Chart
            renderChart(baselineRes, snowballRes);
        }

        // --- Charting ---
        function renderChart(baselineRes, snowballRes) {
            const ctx = document.getElementById('payoffChart').getContext('2d');

            if (chartInstance) {
                chartInstance.destroy();
            }

            // Prepare labels based on the longer schedule (usually baseline)
            let maxMonths = 0;
            if (!baselineRes.error) maxMonths = baselineRes.schedule.length;
            if (!snowballRes.error && snowballRes.schedule.length > maxMonths) maxMonths = snowballRes.schedule.length;

            if (maxMonths === 0) return; // Errors on both

            const labels = [];
            const currentDate = new Date();
            for (let i = 0; i < maxMonths; i += Math.ceil(maxMonths / 20)) { // Sample ~20 points
                const d = new Date();
                d.setMonth(d.getMonth() + i);
                labels.push(d.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }));
            }
            // Ensure last point is included
            const d = new Date();
            d.setMonth(d.getMonth() + maxMonths - 1);
            labels.push(d.toLocaleDateString('en-US', { month: 'short', year: 'numeric' }));


            // Function to map data to sampled labels
            const mapData = (schedule) => {
                if (!schedule) return [];
                const res = [];
                for (let i = 0; i < maxMonths; i += Math.ceil(maxMonths / 20)) {
                    if (i < schedule.length) res.push(schedule[i].totalBalance);
                    else res.push(0);
                }
                // Last point
                if (maxMonths - 1 < schedule.length) res.push(schedule[maxMonths - 1].totalBalance);
                else res.push(0);
                return res;
            };

            const data = {
                labels: labels,
                datasets: []
            };

            if (!snowballRes.error) {
                data.datasets.push({
                    label: 'Snowball Payoff',
                    data: mapData(snowballRes.schedule),
                    borderColor: '#8B5CF6', // var(--primary-color)
                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                });
            }

            if (!baselineRes.error) {
                data.datasets.push({
                    label: 'Minimum Payments',
                    data: mapData(baselineRes.schedule),
                    borderColor: '#94a3b8',
                    borderWidth: 2,
                    borderDash: [5, 5],
                    fill: false,
                    tension: 0.4
                });
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: { family: "'Segoe UI', sans-serif" }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += fmtCurrency.format(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return '$' + (value / 1000) + 'k';
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            renderDebtList();
            calculate();

            // AI Integration Event Listeners
            const aiAskBtn = document.getElementById('aiAskBtn');
            const aiQueryInput = document.getElementById('aiQuery');

            aiAskBtn.addEventListener('click', () => callAIAssistant(aiQueryInput.value));
            aiQueryInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') callAIAssistant(aiQueryInput.value);
            });

            // Initialize Chatbot Widget
            if (!window.yikesAIChatbot && !document.querySelector('.gs-chatbot-widget')) {
                window.yikesAIChatbot = new YikesAIChatbot({
                    apiKey: 'AIzaSyB4ix_spZPsxIw_A3T6X0y6dc33fCmkvqk',
                    position: 'bottom-left'
                });
            }
        });

        // --- AI Integration ---
        async function callAIAssistant(prompt) {
            if (!prompt.trim()) return;

            const aiSpinner = document.getElementById('aiSpinner');
            const aiOutput = document.getElementById('aiOutput');

            try {
                aiSpinner.style.display = 'block';
                aiOutput.style.display = 'none';
                aiOutput.innerHTML = '';

                // Get current calculator state for context
                const extraMonthly = document.getElementById('extraPayment').value;
                const totalDebt = document.getElementById('valTotalDebt').textContent;
                const debtFreeDate = document.getElementById('dateSnowball').textContent;

                const contextData = {
                    debts: debts.map(d => ({ name: d.name, balance: d.balance, rate: d.rate, minPayment: d.minPayment })),
                    extraMonthlyPayment: extraMonthly,
                    totalDebtAmount: totalDebt,
                    currentProjectedPayoffDate: debtFreeDate
                };

                const systemContext = `You are a financial planning AI assistant specializing in debt management.
                
IMPORTANT RESPONSE RULES:
1. Be direct and actionable.
2. Use bullet points (‚Ä¢) or HTML lists for clarity.
3. Always show specific numbers with currency symbols where relevant.
4. Keep responses concise and encouraging (under 250 words).
5. Format the response using clean HTML (e.g., <p>, <ul>, <li>, <strong>) instead of markdown text. DO NOT wrap the response in markdown code blocks like \`\`\`html.

Current Calculator Context:
${JSON.stringify(contextData, null, 2)}`;

                const res = await fetch('/.netlify/functions/gemini-chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: `${systemContext}\n\nUser Query: ${prompt}`
                    })
                });

                const data = await res.json();

                if (res.ok && data.response) {
                    aiOutput.innerHTML = data.response;
                    aiOutput.style.display = 'block';
                } else {
                    aiOutput.innerHTML = '<p>‚ö†Ô∏è AI is temporarily unavailable. Please try again later.</p>';
                    aiOutput.style.display = 'block';
                }
            } catch (e) {
                console.error('AI Error:', e);
                aiOutput.innerHTML = '<p>‚ùå Unable to connect to AI service.</p>';
                aiOutput.style.display = 'block';
            } finally {
                aiSpinner.style.display = 'none';
            }
        }

    </script>

    <!-- External Scripts -->
    <script src="js/chatbotWidget.js"></script>
</body>

</html>