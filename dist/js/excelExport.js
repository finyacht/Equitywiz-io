function parseNumberWithCommas(e){return e&&parseFloat(e.toString().replace(/,/g,""))||0}function exportToExcel(){try{var e=parseNumberWithCommas(document.getElementById("exitAmount").value),t="Waterfall_Analysis_"+e.toLocaleString(),a=window.shareClasses||[],o=window.transactions||[],i=(console.log("Exporting Excel file..."),console.log("Share Classes:",a),console.log("Transactions:",o),XLSX.utils.book_new());addShareClassesSheet(i,a),addTransactionsSheet(i,o),addSummarySheet(i,e,a,o),addDetailedWaterfallSheet(i,e,a,o),addExitDistributionSheet(i,a,o),XLSX.writeFile(i,t+".xlsx")}catch(e){console.error("Error exporting to Excel:",e),alert("There was an error exporting to Excel. Please try again.")}}function addShareClassesSheet(e,t){t=[["Class Name","Type","Seniority","Liquidation Preference","Preference Type","Participation Cap"],...t.map(e=>[e.name,e.type.charAt(0).toUpperCase()+e.type.slice(1),e.seniority,e.liquidationPref+"x",e.prefType.charAt(0).toUpperCase()+e.prefType.slice(1).replace("-"," "),e.cap?e.cap+"x":"N/A"])],t=XLSX.utils.aoa_to_sheet(t);XLSX.utils.book_append_sheet(e,t,"Share Classes");t["!cols"]=[{wch:15},{wch:12},{wch:10},{wch:20},{wch:20},{wch:16}]}function addTransactionsSheet(e,t){t=[["Share Class","Shares","Investment ($)"],...t.map(e=>[e.shareClass,parseInt(e.shares.toString().replace(/,/g,"")),parseInt(e.investment.toString().replace(/,/g,""))])],t=XLSX.utils.aoa_to_sheet(t);XLSX.utils.book_append_sheet(e,t,"Transactions");t["!cols"]=[{wch:15},{wch:15},{wch:15}]}function addSummarySheet(e,t,a,o){a=waterfallCalculator.calculateSummaryWaterfall(a,o,t),o=a.map(e=>{var t=e.percentage.toFixed(2)+"%";return[e.name,e.payout,t,e.components["Liquidation Preference"]||0,e.components.Participation||0,e.components["Common Distribution"]||0,e.components["Additional Distribution"]||0]}),t=["TOTAL",a.reduce((e,t)=>e+t.payout,0),"100.00%",a.reduce((e,t)=>e+(t.components["Liquidation Preference"]||0),0),a.reduce((e,t)=>e+(t.components.Participation||0),0),a.reduce((e,t)=>e+(t.components["Common Distribution"]||0),0),a.reduce((e,t)=>e+(t.components["Additional Distribution"]||0),0)],a=[["Share Class","Total Amount ($)","Percentage","Liquidation Preference ($)","Participation ($)","Common Distribution ($)","Additional Distribution ($)"],...o,t],o=XLSX.utils.aoa_to_sheet(a);XLSX.utils.book_append_sheet(e,o,"Distribution Summary");o["!cols"]=[{wch:15},{wch:18},{wch:12},{wch:22},{wch:18},{wch:22},{wch:22}]}function addDetailedWaterfallSheet(e,t,a,o){a=[["Step","Description","Amount ($)","Remaining Proceeds ($)"],...waterfallCalculator.calculateDetailedWaterfall(a,o,t).map((e,t)=>[0===t?"Starting Amount":"Step "+t,e.name,e.isStarting?e.value:e.value<0?Math.abs(e.value):-Math.abs(e.value),e.remainingProceeds])],o=XLSX.utils.aoa_to_sheet(a);XLSX.utils.book_append_sheet(e,o,"Detailed Waterfall");o["!cols"]=[{wch:15},{wch:40},{wch:15},{wch:20}]}function addExitDistributionSheet(e,t,a){var o=2*parseNumberWithCommas(document.getElementById("exitAmount").value),i=waterfallCalculator.calculateExitDistribution(t,a,o);let n=[];var r=[];i.distributions.forEach(e=>{e.forEach(e=>{n.includes(e.name)||n.push(e.name)})});for(let e=0;e<i.exitValues.length;e++){var s=i.exitValues[e],l=i.distributions[e],c=[s];for(let t of n){var u=l.find(e=>e.name===t);c.push(u?u.payout:0)}r.push(c)}t=[["Exit Value ($)",...n],...r],a=XLSX.utils.aoa_to_sheet(t),XLSX.utils.book_append_sheet(e,a,"Exit Distribution"),o=[{wch:18},...n.map(()=>({wch:18}))];a["!cols"]=o}document.addEventListener("DOMContentLoaded",function(){var e=document.getElementById("exportExcelBtn");e&&e.addEventListener("click",exportToExcel)});